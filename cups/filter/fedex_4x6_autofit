#!/usr/bin/env bash
set -euo pipefail

INPUT="${6:-/dev/stdin}"

# Printer DPI
DPI=203

# 4x6 inches in pixels at 203 dpi
OUT_W=$((4 * DPI))   # 812
OUT_H=$((6 * DPI))   # 1218

# FEDEX label is typically in top-left of letter.

TMPDIR="$(mktemp -d /tmp/fedexlabel.XXXXXX)"
trap 'rm -rf "$TMPDIR"' EXIT

PNG_PAGE="$TMPDIR/page.png"
PNG_CROP="$TMPDIR/crop.png"
PDF_OUT="$TMPDIR/out.pdf"

# Render first page at DPI to PNG (no transparency issues)
# Use -dFirstPage/-dLastPage to keep it fast
/usr/bin/gs -q -dNOPAUSE -dBATCH \
  -sDEVICE=pnggray \
  -r${DPI} \
  -dFirstPage=1 -dLastPage=1 \
  -sOutputFile="$PNG_PAGE" \
  "$INPUT"

# Crop
# Optional nudges (pixels)
X=0
Y=0

ZOOM="${ZOOM:-120}" 

# SCALE-TO-FILL + hard extent to 4x6
convert "$PNG_PAGE" \
  -repage +${X}+${Y} \
  -resize ${OUT_W}x${OUT_H}^ \
  -gravity northwest \
  -extent ${OUT_W}x${OUT_H} \
  "$PNG_CROP"

# Force correct DPI metadata
mogrify -units PixelsPerInch -density ${DPI} "$PNG_CROP"

#identify -format "FINAL px: %wx%h  density: %x x %y\n" "$PNG_CROP" >&2

# Write final PDF (no scaling ambiguity left)
convert -units PixelsPerInch -density ${DPI} "$PNG_CROP" "$PDF_OUT"

cat "$PDF_OUT"
